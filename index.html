<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de M² e Orçamento de Películas</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <style>
        /* Seus estilos CSS existentes aqui */
        /* ... */

        /* Importação de fonte */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Montserrat:wght@600;700&display=swap');

        /* Estilos gerais do corpo da página */
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f4f8;
            color: #333;
        }

        /* Container principal */
        .container {
            max-width: 1000px;
            margin: 20px auto;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        /* Estilos do cabeçalho */
        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 24px;
            color: #2c3e50;
            margin: 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        /* Estilos do container de cliente */
        .cliente-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .cliente-container select,
        .cliente-container input,
        .cliente-container button {
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #fff;
            transition: all 0.3s ease;
        }

        .cliente-container button {
            background: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }

        .cliente-container button:hover {
            background: #45a049;
        }

        /* Estilos do grupo de medidas */
        .medida-group {
            background-color: #f9f9f9;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .medida-group:hover {
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .medida-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 5px;
            margin-bottom: 10px;
        }

        /* Estilos dos inputs numéricos */
        .medida-group input[type="number"] {
            flex: 1;
            min-width: 0;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .medida-group input[placeholder="T"] {
            flex: 1.5;
        }

        /* Estilo da checkbox */
        .medida-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 8px;
            flex-shrink: 0;
            vertical-align: middle;
            cursor: pointer;
        }

        /* Estilos dos ícones de toggle e delete */
        .toggle-icon,
        .delete-button {
            flex-shrink: 0;
            width: 20px;
            height: 20px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 14px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            transition: all 0.3s ease;
        }

        .delete-button {
            background-color: #f44336;
        }

        .toggle-icon:hover,
        .delete-button:hover {
            transform: scale(1.1);
        }

        /* Estilo do resultado total */
        .resultado {
            text-align: right;
            margin-top: 20px;
            font-size: 20px;
            font-weight: bold;
            color: #4CAF50;
        }

        /* Estilos do container de botões */
        .button-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        /* Estilos dos botões principais */
        .add-button,
        .clear-button,
        .pdf-button,
        .duplicate-button {
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            flex-grow: 1;
            text-align: center;
            transition: background 0.3s ease, transform 0.3s ease;
        }

        .add-button {
            background: linear-gradient(45deg, #4CAF50, #388E3C);
        }

        .clear-button {
            background: linear-gradient(45deg, #FF5722, #E64A19);
        }

        .pdf-button {
            background: linear-gradient(45deg, #2196F3, #1976D2);
        }

        .duplicate-button {
            background: linear-gradient(45deg, #FFC107, #FFA000);
        }

        .add-button:hover,
        .clear-button:hover,
        .pdf-button:hover,
        .duplicate-button:hover {
            transform: translateY(-2px);
        }

        /* Estilos dos campos adicionais */
        .additional-fields {
            display: none;
            gap: 10px;
        }

        .additional-fields select {
            flex: 1;
            padding: 8px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        /* Estilos para dispositivos móveis */
        @media (max-width: 600px) {
            .container {
                padding: 10px;
                margin: 10px;
            }

            .medida-group {
                padding: 8px 5px;
            }

            .medida-row {
                flex-wrap: nowrap;
            }

            .medida-group input[type="checkbox"] {
                width: 16px;
                height: 16px;
                margin-right: 5px;
            }

            .medida-group input[type="number"] {
                padding: 8px;
                font-size: 15px;
            }

            .toggle-icon,
            .delete-button {
                width: 20px;
                height: 20px;
                font-size: 10px;
            }

            .additional-fields {
                flex-direction: column;
            }

            .button-container {
                flex-direction: column;
            }

            .add-button,
            .clear-button,
            .pdf-button,
            .duplicate-button {
                width: 100%;
                margin: 5px 0;
            }
        }

        /* Adicione este estilo para o dropdown de películas */
        .pelicula-select {
            flex: 1.5;
            padding: 8px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        /* Seus estilos CSS existentes aqui */
        /* ... */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Calculadora de M² e Orçamento de Películas</h1>
        </div>
        <div class="cliente-container">
            <select id="clienteSelect" onchange="onClienteChange()">
                <option value="">Selecione um cliente</option>
            </select>
            <input type="text" id="novoClienteInput" placeholder="Novo cliente">
            <input type="text" id="telefoneClienteInput" placeholder="Telefone">
            <input type="text" id="enderecoClienteInput" placeholder="Endereço">
            <input type="text" id="cpfClienteInput" placeholder="CPF">
            <button onclick="adicionarCliente()">Adicionar Cliente</button>
        </div>
        <div id="medidasContainer"></div>
        <div class="resultado" id="resultado">Total M²: 0,00 | Preço Total: R$ 0,00</div>
        <div class="button-container">
            <button class="add-button" onclick="addMedidaGroup(true)">Adicionar Medida</button>
            <button class="duplicate-button" onclick="duplicarMedidas()">Duplicar Medidas</button>
            <button class="clear-button" onclick="confirmClearMedidas()">Apagar Cliente</button>
            <button class="pdf-button" id="generatePdfButton">Gerar PDF</button>
        </div>
    </div>

    <script>
        const peliculas = [
            { nome: "Reflecta 15", infravermelho: 90, ultravioleta: 99, vlt: 20, preco: 100 },
            { nome: "Window BLUE", infravermelho: 90, ultravioleta: 99, vlt: 75, preco: 100 },
            { nome: "Color Stable", infravermelho: 80, ultravioleta: 99, vlt: 5, preco: 100 },
            { nome: "Silver 10 Externa", infravermelho: 95, ultravioleta: 99, vlt: 10, preco: 130 },
            { nome: "Prata Reflecta", infravermelho: 95, ultravioleta: 99, vlt: 5, preco: 130 },
            { nome: "Prata Reflecta 15", infravermelho: 90, ultravioleta: 99, vlt: 20, preco: 130 },
            { nome: "Origin Carbon", infravermelho: 90, ultravioleta: 99, vlt: 5, preco: 150 },
            { nome: "Vinil Blackout", infravermelho: 80, ultravioleta: 99, vlt: 0, preco: 150 },
            { nome: "Vinil Jateado", infravermelho: 28, ultravioleta: 99, vlt: 10, preco: 150 },
            { nome: "Window Usa Carbono", infravermelho: 90, ultravioleta: 99, vlt: 5, preco: 150 }
        ];

        let clientes = JSON.parse(localStorage.getItem('clientes')) || [];
        const clienteSelect = document.getElementById('clienteSelect');

        function salvarClientesNoStorage() {
            localStorage.setItem('clientes', JSON.stringify(clientes));
        }

        function salvarClienteSelecionadoNoStorage(cliente) {
            localStorage.setItem('clienteSelecionado', cliente);
        }

        function carregarClienteSelecionadoDoStorage() {
            return localStorage.getItem('clienteSelecionado');
        }

        function adicionarCliente() {
            const novoClienteInput = document.getElementById('novoClienteInput');
            const telefoneClienteInput = document.getElementById('telefoneClienteInput');
            const enderecoClienteInput = document.getElementById('enderecoClienteInput');
            const cpfClienteInput = document.getElementById('cpfClienteInput');
            const novoCliente = novoClienteInput.value.trim();
            const telefoneCliente = telefoneClienteInput.value.trim();
            const enderecoCliente = enderecoClienteInput.value.trim();
            const cpfCliente = cpfClienteInput.value.trim();

            if (novoCliente && !clientes.some(cliente => cliente.nome === novoCliente)) {
                const novoClienteObj = {
                    nome: novoCliente,
                    telefone: telefoneCliente,
                    endereco: enderecoCliente,
                    cpf: cpfCliente
                };
                clientes.push(novoClienteObj);
                salvarClientesNoStorage();
                carregarClientes(novoCliente);
                novoClienteInput.value = '';
                telefoneClienteInput.value = '';
                enderecoClienteInput.value = '';
                cpfClienteInput.value = '';
            }
        }

        document.getElementById('novoClienteInput').addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                adicionarCliente();
            }
        });

        function carregarClientes(clienteSelecionado = '') {
            clienteSelect.innerHTML = '<option value="">Selecione um cliente</option>';
            clientes.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente.nome;
                option.textContent = cliente.nome;
                clienteSelect.appendChild(option);
            });

            if (clienteSelecionado) {
                clienteSelect.value = clienteSelecionado;
                loadMedidas();
            } else {
                const ultimoClienteSelecionado = carregarClienteSelecionadoDoStorage();
                if (ultimoClienteSelecionado && clientes.some(cliente => cliente.nome === ultimoClienteSelecionado)) {
                    clienteSelect.value = ultimoClienteSelecionado;
                } else if (clientes.length > 0) {
                    clienteSelect.value = clientes[clientes.length - 1].nome;
                }
                loadMedidas();
            }
        }

        function onClienteChange() {
            const clienteSelecionado = clienteSelect.value;
            salvarClienteSelecionadoNoStorage(clienteSelecionado);
            loadMedidas();
        }

        function addMedidaGroup(isFirst, largura = '', altura = '', quantidade = 1, isChecked = true, ambiente = '', tipoAplicacao = '', peliculaSelecionada = '') {
            const container = document.getElementById('medidasContainer');
            const medidaGroup = document.createElement('div');
            medidaGroup.classList.add('medida-group');

            medidaGroup.innerHTML = `
                <div class="medida-row">
                    <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="toggleInputs(this)">
                    <input type="number" inputmode="decimal" placeholder="L" value="${largura}" class="largura-input" oninput="calculateTotal()">
                    <input type="number" inputmode="decimal" placeholder="A" value="${altura}" class="altura-input" oninput="calculateTotal()">
                    <input type="number" inputmode="numeric" placeholder="Q" value="${quantidade}" class="quantidade-input" oninput="calculateTotal()">
                    <input type="number" placeholder="T" disabled>
                    <select class="pelicula-select" onchange="calculateTotal()">
                        <option value="">Película</option>
                        ${peliculas.map(p => `<option value="${p.nome}" ${p.nome === peliculaSelecionada ? 'selected' : ''}>${p.nome}</option>`).join('')}
                    </select>
                    <button class="toggle-icon" onclick="toggleAdditionalFields(this)">▼</button>
                    <button class="delete-button" onclick="deleteMedidaGroup(this)">×</button>
  <div class="additional-fields">
            <select onchange="calculateTotal()">
                <option value="">Ambiente</option>
                        <option value="Sala de estar">Sala de estar</option>
                        <option value="Sala de jantar">Sala de jantar</option>
                        <option value="Cozinha">Cozinha</option>
                        <option value="Copa">Copa</option>
                        <option value="Suite 1">Suite 1</option>
                        <option value="Suite 2">Suite 2</option>
                        <option value="Escritorio 1">Escritorio 1</option>
                        <option value="Escritorio 2">Escritorio 2</option>
                        <option value="Escritorio 3">Escritorio 3</option>
                        <option value="Sala de Espera">Sala de Espera</option>
                        <option value="Recepção">Recepção</option>
                        <option value="Garita">Guarita</option>
                        <option value="Portaria">Portaria</option>
                        <option value="Refeitorio">Refeitorio</option>
                        <option value="Refeitorio">Refeitorio</option>
                        <option value="Quarto 1">Quarto 1</option>
                        <option value="Quarto 2">Quarto 2</option>
                        <option value="Quarto 3">Quarto 3</option>
                        <option value="Quarto 4">Quarto 4</option>
                        <option value="Quarto empregada">Quarto empregada</option>
                        <option value="Quarto principal">Quarto principal</option>
                        <option value="Quarto de hóspedes">Quarto de hóspedes</option>
                        <option value="Banheiro 1">Banheiro 1</option>
                        <option value="Banheiro 2">Banheiro 2</option>
                        <option value="Banheiro 3">Banheiro 3</option>
                        <option value="Banheiro de hóspedes">Banheiro de hóspedes</option>
                        <option value="Corredor">Corredor</option>
                        <option value="Escada">Escada</option>
                        <option value="Escritório">Escritório</option>
                        <option value="Lavanderia">Lavanderia</option>
                        <option value="Garagem">Garagem</option>
                        <option value="Varanda">Varanda</option>
                        <option value="Jardim">Jardim</option>
                        <option value="Sotão">Sotão</option>
                        <option value="Porão">Porão</option>
                        <option value="Elevador">Elevador</option>
                        <option value="Outros">Outros</option>
                    </select>
                    <select onchange="calculateTotal()">
                         <option value="">Tipo de Aplicação</option>
                        <option value="Vidro Fixo">Vidro Fixo</option>
                        <option value="Janela Padrão">Janela Padrão</option>
                        <option value="Janelão">Janelão</option>
                        <option value="Janela de correr">Janela de correr</option>
                        <option value="Janela pivotante">Janela pivotante</option>
                        <option value="Basculante">Basculante</option>
                        <option value="Porta">Porta</option>
                        <option value="Porta Balcão">Porta Balcão</option>
                        <option value="Vitrine">Vitrine</option>
                        <option value="Tampo de mesa">Tampo de mesa</option>
                        <option value="Box de banheiro">Box de banheiro</option>
                        <option value="Guarda-corpo">Guarda-corpo</option>
                        <option value="Dispensa">Dispensa</option>
                        <option value="Armário">Armário</option>
                        <option value="Teto">Teto</option>
                        <option value="Parede divisória">Parede divisória</option>
                        <option value="Fachada">Fachada</option>
                        <option value="Claraboia">Claraboia</option>
                        <option value="Balcão">Balcão</option>
                        <option value="Outras">Outras</option>
                    </select>
                </div>
            `;

            container.appendChild(medidaGroup);

            const inputs = medidaGroup.querySelectorAll('input[type="number"]');
            inputs.forEach((input, index) => {
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        if (index < inputs.length - 2) {
                            inputs[index + 1].focus();
                        } else {
                            const nextGroup = medidaGroup.nextElementSibling;
                            if (nextGroup) {
                                nextGroup.querySelector('.largura-input').focus();
                            } else {
                                addMedidaGroup(true);
                            }
                        }
                    }
                });

                input.addEventListener('input', function() {
                    if (this.value.length >= 2) {
                        const nextInput = this.nextElementSibling;
                        if (nextInput && nextInput.tagName === 'INPUT' && !nextInput.disabled) {
                            nextInput.focus();
                        }
                    }
                });
            });

            if (isFirst) {
                medidaGroup.querySelector('.largura-input').focus();
            }

            const selects = medidaGroup.querySelectorAll('select');
            if (selects.length > 1) {
                selects[0].value = ambiente;
                selects[1].value = tipoAplicacao;
            }

            calculateTotal();
        }

        function toggleAdditionalFields(button) {
            const fields = button.closest('.medida-group').querySelector('.additional-fields');
            if (fields.style.display === 'none' || fields.style.display === '') {
                fields.style.display = 'flex';
                button.textContent = '▲';
            } else {
                fields.style.display = 'none';
                button.textContent = '▼';
            }
        }

        function deleteMedidaGroup(button) {
            if (confirm('Tem certeza que deseja excluir este grupo de medidas?')) {
                button.closest('.medida-group').remove();
                calculateTotal();
                saveMedidas();
            }
        }

        function duplicarMedidas() {
            const medidaGroups = document.querySelectorAll('.medida-group');
            medidaGroups.forEach(group => {
                const largura = group.querySelector('input[placeholder="L"]').value || '';
                const altura = group.querySelector('input[placeholder="A"]').value || '';
                const quantidade = group.querySelector('input[placeholder="Q"]').value || '';
                const ambiente = group.querySelector('select:nth-of-type(1)').value || '';
                const tipoAplicacao = group.querySelector('select:nth-of-type(2)').value || '';
                const peliculaSelecionada = group.querySelector('.pelicula-select').value || '';

                addMedidaGroup(false, largura, altura, quantidade, true, ambiente, tipoAplicacao, peliculaSelecionada);
            });
            calculateTotal();
        }

        function calculateTotal() {
            const medidaGroups = document.querySelectorAll('.medida-group');
            let totalM2 = 0;
            let precoTotal = 0;

            medidaGroups.forEach(group => {
                const isChecked = group.querySelector('input[type="checkbox"]').checked;
                const largura = parseFloat(group.querySelector('input[placeholder="L"]').value) || 0;
                const altura = parseFloat(group.querySelector('input[placeholder="A"]').value) || 0;
                const quantidade = parseInt(group.querySelector('input[placeholder="Q"]').value) || 0;
                const peliculaNome = group.querySelector('.pelicula-select').value;
                const pelicula = peliculas.find(p => p.nome === peliculaNome);

                const area = largura * altura * quantidade;
                const preco = pelicula ? area * pelicula.preco : 0;

                if (isChecked) {
                    totalM2 += area;
                    precoTotal += preco;
                    group.querySelector('input[placeholder="T"]').value = area.toFixed(2);
                } else {
                    group.querySelector('input[placeholder="T"]').value = '0.00';
                }
            });

            document.getElementById('resultado').innerText = `Total M²: ${totalM2.toFixed(2)} | Preço Total: R$ ${precoTotal.toFixed(2)}`;
            saveMedidas();
        }

        function toggleInputs(checkbox) {
            const inputs = checkbox.closest('.medida-row').querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.disabled = !checkbox.checked;
            });
            calculateTotal();
        }

        function saveMedidas() {
            const cliente = clienteSelect.value;
            if (!cliente) return;

            const medidaGroups = document.querySelectorAll('.medida-group');
            const medidas = Array.from(medidaGroups).map(group => {
                const isChecked = group.querySelector('input[type="checkbox"]').checked;
                const largura = group.querySelector('input[placeholder="L"]').value || '';
                const altura = group.querySelector('input[placeholder="A"]').value || '';
                const quantidade = group.querySelector('input[placeholder="Q"]').value || '';
                const ambiente = group.querySelector('select:nth-of-type(1)').value || '';
                const tipoAplicacao = group.querySelector('select:nth-of-type(2)').value || '';
                const pelicula = group.querySelector('.pelicula-select').value || '';
                return { isChecked, largura, altura, quantidade, ambiente, tipoAplicacao, pelicula };
            });

            localStorage.setItem(`medidas_${cliente}`, JSON.stringify(medidas));
        }

        function loadMedidas() {
            const cliente = clienteSelect.value;
            const savedMedidas = localStorage.getItem(`medidas_${cliente}`);
            const medidasContainer = document.getElementById('medidasContainer');
            medidasContainer.innerHTML = '';

            if (savedMedidas) {
                const medidas = JSON.parse(savedMedidas);
                medidas.forEach(medida => {
                    addMedidaGroup(false, medida.largura, medida.altura, medida.quantidade, medida.isChecked, medida.ambiente, medida.tipoAplicacao, medida.pelicula);
                });
            } else {
                addMedidaGroup(true);
            }
            calculateTotal();
        }

        function clearMedidas() {
            const cliente = clienteSelect.value;
            if (!cliente) {
                alert('Selecione um cliente.');
                return;
            }

            localStorage.removeItem(`medidas_${cliente}`);
            const index = clientes.findIndex(c => c.nome === cliente);
            if (index > -1) {
                clientes.splice(index, 1);
                localStorage.setItem('clientes', JSON.stringify(clientes));
            }

            carregarClientes();
            document.getElementById('medidasContainer').innerHTML = '';
            addMedidaGroup(true);
            calculateTotal();
        }

        function confirmClearMedidas() {
            if (confirm("Tem certeza que deseja apagar este cliente e suas medidas?")) {
                clearMedidas();
            }
        }

        function generatePDF() {
            try {
                const clienteNome = clienteSelect.value;
                if (!clienteNome) {
                    alert('Selecione um cliente.');
                    return;
                }

                const cliente = clientes.find(c => c.nome === clienteNome);
                if (!cliente) {
                    alert('Informações do cliente não encontradas.');
                    return;
                }

                const { jsPDF } = jspdf;
                const doc = new jsPDF();
                const pageWidth = doc.internal.pageSize.width;
                const pageHeight = doc.internal.pageSize.height;
                const margin = 15;
                let y = margin;

                function addPage() {
                    doc.addPage();
                    y = margin;
                    addHeader();
                    addFooter();
                }

                function addHeader() {
                    const date = new Date().toLocaleDateString('pt-BR');
                    const time = new Date().toLocaleTimeString('pt-BR');

                    doc.setFillColor(41, 128, 185);
                    doc.rect(0, 0, pageWidth, 35, 'F');

                    doc.setTextColor(255);
                    doc.setFontSize(24);
                    doc.setFont("helvetica", 'bold');
                    doc.text("FUME JP", margin, 25);

                    doc.setFontSize(16);
                    doc.setFont("helvetica", 'normal');
                    doc.text("Orçamento de Medidas", pageWidth - margin, 20, { align: 'right' });

                    doc.setFontSize(10);
                    doc.text(`Data: ${date} | Hora: ${time}`, pageWidth - margin, 30, { align: 'right' });

                    y = 45;
                }

                function addFooter() {
                    doc.setFillColor(41, 128, 185);
                    doc.rect(0, pageHeight - 20, pageWidth, 20, 'F');

                    doc.setTextColor(255);
                    doc.setFontSize(10);
                    doc.text(`Página ${doc.internal.getNumberOfPages()}`, pageWidth / 2, pageHeight - 10, { align: 'center' });

                    doc.setTextColor(255, 255, 255);
                    doc.textWithLink('Contato: (83) 99301-5765', margin, pageHeight - 10, { url: 'https://wa.me/5583993015765' });
                    doc.textWithLink('WWW.fumejp.com.br', pageWidth - margin, pageHeight - 10, { align: 'right', url: 'https://fumejp.com.br/' });
                }

                function addSectionTitle(title) {
                    if (y > pageHeight - 40) addPage();
                    doc.setFillColor(52, 152, 219);
                    doc.rect(margin, y, pageWidth - 2 * margin, 10, 'F');
                    doc.setTextColor(255);
                    doc.setFontSize(14);
                    doc.setFont("helvetica", 'bold');
                    doc.text(title, margin + 5, y + 7);
                    y += 15;
                }

                function addClienteInfo(cliente) {
                    if (y > pageHeight - 60) addPage();
                    doc.setFontSize(12);
                    doc.setFont("helvetica", 'normal');
                    doc.setTextColor(52, 73, 94);
                    doc.text(`Cliente: ${cliente.nome}`, margin, y);
                    doc.text(`Telefone: ${cliente.telefone}`, margin, y + 10);
                    doc.text(`Endereço: ${cliente.endereco}`, margin, y + 20);
                    doc.text(`CPF: ${cliente.cpf}`, margin, y + 30);
                    y += 40;
                }

                function addMedidaItem(medida, index) {
                    if (y > pageHeight - 70) addPage();

                    const isChecked = medida.querySelector('input[type="checkbox"]')?.checked;
                    const largura = medida.querySelector('input[placeholder="L"]')?.value || '0';
                    const altura = medida.querySelector('input[placeholder="A"]')?.value || '0';
                    const quantidade = medida.querySelector('input[placeholder="Q"]')?.value || '0';
                    const totalM2 = medida.querySelector('input[placeholder="T"]')?.value || '0';
                    const ambiente = medida.querySelector('select:nth-of-type(1)')?.value || '';
                    const tipoAplicacao = medida.querySelector('select:nth-of-type(2)')?.value || '';
                    const peliculaNome = medida.querySelector('.pelicula-select')?.value || '';
                    const pelicula = peliculas.find(p => p.nome === peliculaNome);

                    if (index % 2 === 0) {
                        doc.setFillColor(240, 240, 240);
                        doc.rect(margin, y, pageWidth - 2 * margin, 50, 'F');
                    }

                    doc.setTextColor(52, 73, 94);
                    doc.setFontSize(12);
                    doc.setFont("helvetica", 'bold');
                    doc.text(`Medida ${index + 1}`, margin + 5, y + 6);

                    doc.setFont("helvetica", 'normal');
                    doc.setFontSize(10);
                    doc.text(`L: ${largura} | A: ${altura} | Q: ${quantidade} | Total: ${totalM2} m²`, margin + 5, y + 16);
                    doc.text(`Ambiente: ${ambiente}`, margin + 5, y + 26);
                    doc.text(`Tipo de Aplicação: ${tipoAplicacao}`, margin + 5, y + 36);

                    if (pelicula) {
                        doc.text(`Película: ${pelicula.nome}`, pageWidth / 2, y + 26);
                        doc.text(`Preço: R$ ${(pelicula.preco * parseFloat(totalM2)).toFixed(2)}`, pageWidth / 2, y + 36);
                    }

                    if (isChecked) {
                        doc.setFillColor(39, 174, 96);
                        doc.circle(pageWidth - margin - 10, y + 15, 4, 'F');
                        doc.setTextColor(255);
                        doc.text("✓", pageWidth - margin - 11.5, y + 16.5);
                    }

                    y += 55;
                }

                addHeader();
                addFooter();
                addClienteInfo(cliente);

                const medidaGroups = document.querySelectorAll('.medida-group');
                const medidasPorPelicula = {};
                const totaisPorPelicula = {};

                medidaGroups.forEach(group => {
                    const peliculaNome = group.querySelector('.pelicula-select').value || 'Sem Película';
                    if (!medidasPorPelicula[peliculaNome]) {
                        medidasPorPelicula[peliculaNome] = [];
                        totaisPorPelicula[peliculaNome] = { totalM2: 0, precoTotal: 0 };
                    }
                    const largura = parseFloat(group.querySelector('input[placeholder="L"]').value) || 0;
                    const altura = parseFloat(group.querySelector('input[placeholder="A"]').value) || 0;
                    const quantidade = parseInt(group.querySelector('input[placeholder="Q"]').value) || 0;
                    const pelicula = peliculas.find(p => p.nome === peliculaNome);
                    const area = largura * altura * quantidade;
                    const preco = pelicula ? area * pelicula.preco : 0;

                    medidasPorPelicula[peliculaNome].push(group);
                    totaisPorPelicula[peliculaNome].totalM2 += area;
                    totaisPorPelicula[peliculaNome].precoTotal += preco;
                });

                Object.keys(medidasPorPelicula).forEach(peliculaNome => {
                    addSectionTitle(`Orçamento para: ${peliculaNome}`);
                    medidasPorPelicula[peliculaNome].forEach((group, index) => {
                        addMedidaItem(group, index + 1);
                    });

                    y += 10;
                    doc.setFont("helvetica", 'bold');
                    doc.setFontSize(16);
                    doc.setTextColor(41, 128, 185);
                    doc.text(`Total para ${peliculaNome}:`, margin, y);
                    y += 10;
                    doc.setFontSize(14);
                    doc.setTextColor(52, 73, 94);
                    doc.text(`Total M²: ${totaisPorPelicula[peliculaNome].totalM2.toFixed(2)} | Preço Total: R$ ${totaisPorPelicula[peliculaNome].precoTotal.toFixed(2)}`, margin, y);
                    y += 20;
                });

                const watermarkText = "FUME JP";
                doc.setFont("helvetica", 'bold');
                doc.setTextColor(230, 230, 230, 0.5);
                doc.setFontSize(60);
                doc.text(watermarkText, pageWidth / 2, pageHeight / 2, {
                    align: 'center',
                    angle: 45
                });

                doc.save(`orcamento_${cliente.nome.replace(/\s+/g, '_').toLowerCase()}.pdf`);
            } catch (error) {
                console.error("Erro ao gerar PDF:", error);
                alert("Ocorreu um erro ao gerar o PDF. Por favor, verifique o console para mais detalhes.");
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            carregarClientes();
            document.getElementById('generatePdfButton').addEventListener('click', generatePDF);
        });
    </script>
</body>
</html>
